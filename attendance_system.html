<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ì¶œì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ê´€ë¦¬ì í˜ì´ì§€ */
        .schedule-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .day-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .day-header {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .lecture-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .lecture-info {
            flex: 1;
        }

        .lecture-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .lecture-time {
            color: #666;
            font-size: 0.9em;
        }

        .lecture-location {
            color: #999;
            font-size: 0.85em;
            margin-top: 3px;
        }

        .qr-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .qr-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* QR ì½”ë“œ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            display: inline-block;
        }

        .close-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
        }

        /* í•™ìƒ ì¶œì„ ì²´í¬ */
        .attendance-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        #reader {
            margin: 20px 0;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
        }

        .submit-btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #5568d3;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ì¶œì„ë¶€ */
        .attendance-table-container {
            overflow-x: auto;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .attendance-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .attendance-table tr:hover {
            background: #f8f9fa;
        }

        .status-present {
            color: #4caf50;
            font-weight: bold;
        }

        .status-absent {
            color: #f44336;
            font-weight: bold;
        }

        .status-late {
            color: #ff9800;
            font-weight: bold;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .export-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š QR ì¶œì„ ì‹œìŠ¤í…œ</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('admin')">ê´€ë¦¬ì</button>
            <button class="tab" onclick="switchTab('student')">í•™ìƒ ì¶œì„</button>
            <button class="tab" onclick="switchTab('records')">ì¶œì„ë¶€</button>
        </div>

        <!-- ê´€ë¦¬ì íƒ­ -->
        <div id="admin" class="tab-content active">
            <h2>ğŸ“… êµìœ¡ ì¼ì • ë° QR ì½”ë“œ ìƒì„±</h2>
            <div class="schedule-grid" id="scheduleGrid"></div>
        </div>

        <!-- í•™ìƒ ì¶œì„ ì²´í¬ íƒ­ -->
        <div id="student" class="tab-content">
            <div class="attendance-form">
                <h2>âœ… ì¶œì„ ì²´í¬</h2>
                <div id="studentAlert"></div>
                
                <div class="form-group">
                    <label for="studentName">ì´ë¦„</label>
                    <input type="text" id="studentName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>

                <div class="form-group">
                    <label>QR ì½”ë“œ ìŠ¤ìº”</label>
                    <div id="reader"></div>
                </div>

                <button class="submit-btn" id="manualCheckBtn" onclick="manualAttendance()">ìˆ˜ë™ ì¶œì„ ì²´í¬</button>
            </div>
        </div>

        <!-- ì¶œì„ë¶€ íƒ­ -->
        <div id="records" class="tab-content">
            <h2>ğŸ“‹ ì¶œì„ë¶€</h2>
            
            <div class="stats-grid" id="statsGrid"></div>

            <div class="filter-group">
                <select id="filterDay" onchange="filterAttendance()">
                    <option value="">ì „ì²´ ë‚ ì§œ</option>
                    <option value="1">1ì¼ì°¨</option>
                    <option value="2">2ì¼ì°¨</option>
                    <option value="3">3ì¼ì°¨</option>
                    <option value="4">4ì¼ì°¨</option>
                    <option value="5">5ì¼ì°¨</option>
                </select>

                <select id="filterSubject" onchange="filterAttendance()">
                    <option value="">ì „ì²´ ê³¼ëª©</option>
                    <option value="ì›¹ í”„ë¡œê·¸ë˜ë° ê¸°ì´ˆ">ì›¹ í”„ë¡œê·¸ë˜ë° ê¸°ì´ˆ</option>
                    <option value="ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„">ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„</option>
                    <option value="UI/UX ë””ìì¸">UI/UX ë””ìì¸</option>
                    <option value="í”„ë¡œì íŠ¸ ê´€ë¦¬">í”„ë¡œì íŠ¸ ê´€ë¦¬</option>
                    <option value="íŒ€ í˜‘ì—… ì‹¤ìŠµ">íŒ€ í˜‘ì—… ì‹¤ìŠµ</option>
                </select>

                <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="attendance-table-container">
                <table class="attendance-table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ê°•ì¢Œëª…</th>
                            <th>ìˆ˜ê°•ìƒ</th>
                            <th>ì¶œì„ ì‹œê°„</th>
                            <th>ì¶œê²° ìƒíƒœ</th>
                            <th>ìœ„ì¹˜ í™•ì¸</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- QR ì½”ë“œ ëª¨ë‹¬ -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <h2 id="modalTitle">QR ì½”ë“œ</h2>
            <p id="modalInfo"></p>
            <div id="qrcode"></div>
            <button class="close-btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // êµìœ¡ ì¼ì • ë°ì´í„°
        const schedule = [
            {
                day: 1,
                date: '2024-11-01',
                lectures: [
                    { subject: 'ì›¹ í”„ë¡œê·¸ë˜ë° ê¸°ì´ˆ', time: '09:00-12:00', location: '101í˜¸', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 2,
                date: '2024-11-02',
                lectures: [
                    { subject: 'ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„', time: '09:00-12:00', location: '102í˜¸', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 3,
                date: '2024-11-03',
                lectures: [
                    { subject: 'UI/UX ë””ìì¸', time: '09:00-12:00', location: '103í˜¸', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 4,
                date: '2024-11-04',
                lectures: [
                    { subject: 'í”„ë¡œì íŠ¸ ê´€ë¦¬', time: '09:00-12:00', location: '104í˜¸', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 5,
                date: '2024-11-05',
                lectures: [
                    { subject: 'íŒ€ í˜‘ì—… ì‹¤ìŠµ', time: '09:00-12:00', location: '105í˜¸', lat: 37.5665, lng: 126.9780 }
                ]
            }
        ];

        // ì¶œì„ ê¸°ë¡ ì €ì¥
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        
        // ì¥ì¹˜ ê³ ìœ  ID ìƒì„± (ë¸Œë¼ìš°ì € fingerprint)
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                // ê³ ìœ  ID ìƒì„± (ëœë¤ + íƒ€ì„ìŠ¤íƒ¬í”„)
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // QR ìŠ¤ìºë„ˆ ì¸ìŠ¤í„´ìŠ¤
        let html5QrCode = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            renderSchedule();
            renderAttendanceTable();
            updateStats();
            initQRScanner();
        });

        // ì¼ì • ë Œë”ë§
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';

            schedule.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                
                let lecturesHTML = '';
                day.lectures.forEach((lecture, index) => {
                    lecturesHTML += `
                        <div class="lecture-item">
                            <div class="lecture-info">
                                <div class="lecture-title">${lecture.subject}</div>
                                <div class="lecture-time">â° ${lecture.time}</div>
                                <div class="lecture-location">ğŸ“ ${lecture.location}</div>
                            </div>
                            <button class="qr-btn" onclick="generateQR(${day.day}, ${index})">
                                QR ìƒì„±
                            </button>
                        </div>
                    `;
                });

                dayCard.innerHTML = `
                    <div class="day-header">${day.day}ì¼ì°¨ (${day.date})</div>
                    ${lecturesHTML}
                `;

                grid.appendChild(dayCard);
            });
        }

        // QR ì½”ë“œ ìƒì„±
        function generateQR(day, lectureIndex) {
            const dayData = schedule[day - 1];
            const lecture = dayData.lectures[lectureIndex];
            
            const qrData = {
                day: day,
                date: dayData.date,
                subject: lecture.subject,
                time: lecture.time,
                location: lecture.location,
                lat: lecture.lat,
                lng: lecture.lng,
                timestamp: new Date().getTime()
            };

            document.getElementById('modalTitle').textContent = `${lecture.subject} QR ì½”ë“œ`;
            document.getElementById('modalInfo').textContent = `${day}ì¼ì°¨ | ${lecture.time} | ${lecture.location}`;
            
            document.getElementById('qrcode').innerHTML = '';
            QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(qrData), {
                width: 300,
                margin: 2
            }, function(error, canvas) {
                if (error) {
                    console.error(error);
                    return;
                }
                document.getElementById('qrcode').appendChild(canvas);
            });

            document.getElementById('qrModal').classList.add('active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('qrModal').classList.remove('active');
        }

        // QR ìŠ¤ìºë„ˆ ì´ˆê¸°í™”
        function initQRScanner() {
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode = new Html5Qrcode("reader");
            
            // ì¹´ë©”ë¼ ì‹œì‘ì€ íƒ­ì´ í™œì„±í™”ë  ë•Œë§Œ
            document.querySelector('[onclick*="student"]').addEventListener('click', startScanner);
        }

        function startScanner() {
            if (html5QrCode && !html5QrCode.isScanning) {
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanError
                ).catch(err => {
                    console.log("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:", err);
                });
            }
        }

        // QR ìŠ¤ìº” ì„±ê³µ
        function onScanSuccess(decodedText, decodedResult) {
            try {
                const qrData = JSON.parse(decodedText);
                processAttendance(qrData);
            } catch (e) {
                showAlert('error', 'ìœ íš¨í•˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.');
            }
        }

        function onScanError(errorMessage) {
            // ìŠ¤ìº” ì—ëŸ¬ëŠ” ë¬´ì‹œ (ê³„ì† ìŠ¤ìº”)
        }

        // ì¶œì„ ì²˜ë¦¬
        function processAttendance(qrData) {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showAlert('error', 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìœ„ì¹˜ í™•ì¸
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const distance = calculateDistance(
                            position.coords.latitude,
                            position.coords.longitude,
                            qrData.lat,
                            qrData.lng
                        );

                        // 500m ì´ë‚´ë§Œ ì¶œì„ ì¸ì •
                        if (distance > 0.5) {
                            showAlert('error', 'ì¶œì„ ê°€ëŠ¥í•œ ìœ„ì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤. (ê±°ë¦¬: ' + distance.toFixed(2) + 'km)');
                            return;
                        }

                        // ì‹œê°„ í™•ì¸
                        const [startTime, endTime] = qrData.time.split('-');
                        const now = new Date();
                        const currentTime = now.getHours() * 60 + now.getMinutes();
                        const [startHour, startMin] = startTime.split(':').map(Number);
                        const [endHour, endMin] = endTime.split(':').map(Number);
                        const classStart = startHour * 60 + startMin;
                        const classEnd = endHour * 60 + endMin;

                        let status = 'ì¶œì„';
                        if (currentTime < classStart) {
                            showAlert('error', 'ì•„ì§ ì¶œì„ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.');
                            return;
                        } else if (currentTime > classEnd) {
                            showAlert('error', 'ì¶œì„ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            return;
                        } else if (currentTime > classStart + 10) {
                            status = 'ì§€ê°';
                        }

                        // ì¥ì¹˜ ID ê°€ì ¸ì˜¤ê¸°
                        const deviceId = getDeviceId();
                        
                        // ì¤‘ë³µ ì¶œì„ í™•ì¸ 1: ê°™ì€ ì´ë¦„ìœ¼ë¡œ ì´ë¯¸ ì¶œì„í–ˆëŠ”ì§€
                        const duplicateName = attendanceRecords.find(r => 
                            r.name === studentName && 
                            r.day === qrData.day && 
                            r.subject === qrData.subject
                        );

                        if (duplicateName) {
                            showAlert('warning', 'ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        // ì¤‘ë³µ ì¶œì„ í™•ì¸ 2: ê°™ì€ ì¥ì¹˜ì—ì„œ ì´ë¯¸ ì¶œì„í–ˆëŠ”ì§€ (ëŒ€ë¦¬ì¶œì„ ë°©ì§€)
                        const duplicateDevice = attendanceRecords.find(r => 
                            r.deviceId === deviceId && 
                            r.day === qrData.day && 
                            r.subject === qrData.subject
                        );

                        if (duplicateDevice) {
                            showAlert('error', `ì´ ê¸°ê¸°ëŠ” ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¶œì„ì: ${duplicateDevice.name}\n\nëŒ€ë¦¬ ì¶œì„ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                            return;
                        }

                        // ì¶œì„ ê¸°ë¡ ì €ì¥
                        const record = {
                            day: qrData.day,
                            date: qrData.date,
                            subject: qrData.subject,
                            name: studentName,
                            time: now.toLocaleTimeString('ko-KR'),
                            status: status,
                            location: qrData.location,
                            distance: distance.toFixed(3) + 'km',
                            timestamp: now.getTime(),
                            deviceId: deviceId  // ì¥ì¹˜ ID ì¶”ê°€
                        };

                        attendanceRecords.push(record);
                        localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));

                        showAlert('success', `ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (${status})`);
                        renderAttendanceTable();
                        updateStats();

                        // ì…ë ¥ ì´ˆê¸°í™”
                        document.getElementById('studentName').value = '';
                    },
                    (error) => {
                        showAlert('error', 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showAlert('error', 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ìˆ˜ë™ ì¶œì„ (í…ŒìŠ¤íŠ¸ìš©)
        function manualAttendance() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showAlert('error', 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ê°•ì˜ ì°¾ê¸°
            const now = new Date();
            const currentHour = now.getHours();
            
            // ì˜¤ì „ 9ì‹œ~12ì‹œ ì‚¬ì´ë§Œ ì¶œì„ ê°€ëŠ¥
            if (currentHour < 9 || currentHour >= 12) {
                showAlert('error', 'ì¶œì„ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (09:00-12:00)');
                return;
            }

            // ì„ì‹œë¡œ 1ì¼ì°¨ ê°•ì˜ë¡œ ì¶œì„ ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” ë‚ ì§œ ë¹„êµ í•„ìš”)
            const dayData = schedule[0];
            const lecture = dayData.lectures[0];

            // ì¥ì¹˜ ID ê°€ì ¸ì˜¤ê¸°
            const deviceId = getDeviceId();
            
            // ì¤‘ë³µ í™•ì¸
            const duplicateDevice = attendanceRecords.find(r => 
                r.deviceId === deviceId && 
                r.day === dayData.day && 
                r.subject === lecture.subject
            );

            if (duplicateDevice) {
                showAlert('error', `ì´ ê¸°ê¸°ëŠ” ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¶œì„ì: ${duplicateDevice.name}\n\nëŒ€ë¦¬ ì¶œì„ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                return;
            }
            
            const record = {
                day: dayData.day,
                date: dayData.date,
                subject: lecture.subject,
                name: studentName,
                time: now.toLocaleTimeString('ko-KR'),
                status: 'ì¶œì„',
                location: lecture.location,
                distance: 'ìˆ˜ë™ì²´í¬',
                timestamp: now.getTime(),
                deviceId: deviceId  // ì¥ì¹˜ ID ì¶”ê°€
            };

            attendanceRecords.push(record);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));

            showAlert('success', 'ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            renderAttendanceTable();
            updateStats();

            document.getElementById('studentName').value = '';
        }

        // ê±°ë¦¬ ê³„ì‚° (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ì¶œì„ë¶€ ë Œë”ë§
        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceBody');
            tbody.innerHTML = '';

            const filterDay = document.getElementById('filterDay')?.value;
            const filterSubject = document.getElementById('filterSubject')?.value;

            let filteredRecords = attendanceRecords;

            if (filterDay) {
                filteredRecords = filteredRecords.filter(r => r.day == filterDay);
            }

            if (filterSubject) {
                filteredRecords = filteredRecords.filter(r => r.subject === filterSubject);
            }

            // ìµœì‹ ìˆœ ì •ë ¬
            filteredRecords.sort((a, b) => b.timestamp - a.timestamp);

            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                const statusClass = record.status === 'ì¶œì„' ? 'status-present' : 
                                  record.status === 'ì§€ê°' ? 'status-late' : 'status-absent';
                
                row.innerHTML = `
                    <td>${record.day}ì¼ì°¨ (${record.date})</td>
                    <td>${record.subject}</td>
                    <td>${record.name}</td>
                    <td>${record.time}</td>
                    <td class="${statusClass}">${record.status}</td>
                    <td>${record.distance}</td>
                `;
                tbody.appendChild(row);
            });

            if (filteredRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const totalRecords = attendanceRecords.length;
            const presentCount = attendanceRecords.filter(r => r.status === 'ì¶œì„').length;
            const lateCount = attendanceRecords.filter(r => r.status === 'ì§€ê°').length;
            const uniqueStudents = new Set(attendanceRecords.map(r => r.name)).size;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalRecords}</div>
                    <div class="stat-label">ì´ ì¶œì„ ê¸°ë¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${presentCount}</div>
                    <div class="stat-label">ì •ìƒ ì¶œì„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${lateCount}</div>
                    <div class="stat-label">ì§€ê°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${uniqueStudents}</div>
                    <div class="stat-label">ìˆ˜ê°•ìƒ ìˆ˜</div>
                </div>
            `;
        }

        // í•„í„°ë§
        function filterAttendance() {
            renderAttendanceTable();
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            if (attendanceRecords.length === 0) {
                alert('ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let csv = 'ë‚ ì§œ,ê°•ì¢Œëª…,ìˆ˜ê°•ìƒ,ì¶œì„ì‹œê°„,ì¶œê²°ìƒíƒœ,ìœ„ì¹˜í™•ì¸\n';
            
            attendanceRecords.forEach(record => {
                csv += `${record.day}ì¼ì°¨ (${record.date}),${record.subject},${record.name},${record.time},${record.status},${record.distance}\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì¶œì„ë¶€_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(type, message) {
            const alertDiv = document.getElementById('studentAlert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';

            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // QR ìŠ¤ìºë„ˆ ì‹œì‘/ì •ì§€
            if (tabName === 'student') {
                setTimeout(startScanner, 100);
            } else if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }

            // ì¶œì„ë¶€ íƒ­ì¼ ê²½ìš° ë°ì´í„° ê°±ì‹ 
            if (tabName === 'records') {
                renderAttendanceTable();
                updateStats();
            }
        }

        // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ì¹´ë©”ë¼ ì •ì§€
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>