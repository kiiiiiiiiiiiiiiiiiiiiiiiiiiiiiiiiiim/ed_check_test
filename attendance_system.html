<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Ï∂úÏÑù ÏãúÏä§ÌÖú</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ */
        .schedule-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .day-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .day-header {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .lecture-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .lecture-info {
            flex: 1;
        }

        .lecture-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .lecture-time {
            color: #666;
            font-size: 0.9em;
        }

        .lecture-location {
            color: #999;
            font-size: 0.85em;
            margin-top: 3px;
        }

        .qr-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .qr-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* QR ÏΩîÎìú Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            display: inline-block;
        }

        .close-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
        }

        /* ÌïôÏÉù Ï∂úÏÑù Ï≤¥ÌÅ¨ */
        .attendance-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        #reader {
            margin: 20px 0;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
        }

        .submit-btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #5568d3;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Ï∂úÏÑùÎ∂Ä */
        .attendance-table-container {
            overflow-x: auto;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .attendance-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .attendance-table tr:hover {
            background: #f8f9fa;
        }

        .status-present {
            color: #4caf50;
            font-weight: bold;
        }

        .status-absent {
            color: #f44336;
            font-weight: bold;
        }

        .status-late {
            color: #ff9800;
            font-weight: bold;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .export-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö QR Ï∂úÏÑù ÏãúÏä§ÌÖú</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('admin')">Í¥ÄÎ¶¨Ïûê</button>
            <button class="tab" onclick="switchTab('student')">ÌïôÏÉù Ï∂úÏÑù</button>
            <button class="tab" onclick="switchTab('records')">Ï∂úÏÑùÎ∂Ä</button>
        </div>

        <!-- Í¥ÄÎ¶¨Ïûê ÌÉ≠ -->
        <div id="admin" class="tab-content active">
            <h2>üìÖ ÍµêÏú° ÏùºÏ†ï Î∞è QR ÏΩîÎìú ÏÉùÏÑ±</h2>
            <div class="schedule-grid" id="scheduleGrid"></div>
        </div>

        <!-- ÌïôÏÉù Ï∂úÏÑù Ï≤¥ÌÅ¨ ÌÉ≠ -->
        <div id="student" class="tab-content">
            <div class="attendance-form">
                <h2>‚úÖ Ï∂úÏÑù Ï≤¥ÌÅ¨</h2>
                <div id="studentAlert"></div>
                
                <div class="form-group">
                    <label for="studentName">Ïù¥Î¶Ñ</label>
                    <input type="text" id="studentName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required>
                </div>

                <div class="form-group">
                    <label>QR ÏΩîÎìú Ïä§Ï∫î</label>
                    <div id="reader"></div>
                </div>

                <button class="submit-btn" id="manualCheckBtn" onclick="manualAttendance()">ÏàòÎèô Ï∂úÏÑù Ï≤¥ÌÅ¨</button>
            </div>
        </div>

        <!-- Ï∂úÏÑùÎ∂Ä ÌÉ≠ -->
        <div id="records" class="tab-content">
            <h2>üìã Ï∂úÏÑùÎ∂Ä</h2>
            
            <div class="stats-grid" id="statsGrid"></div>

            <div class="filter-group">
                <select id="filterDay" onchange="filterAttendance()">
                    <option value="">Ï†ÑÏ≤¥ ÎÇ†Ïßú</option>
                    <option value="1">1ÏùºÏ∞®</option>
                    <option value="2">2ÏùºÏ∞®</option>
                    <option value="3">3ÏùºÏ∞®</option>
                    <option value="4">4ÏùºÏ∞®</option>
                    <option value="5">5ÏùºÏ∞®</option>
                </select>

                <select id="filterSubject" onchange="filterAttendance()">
                    <option value="">Ï†ÑÏ≤¥ Í≥ºÎ™©</option>
                    <option value="Ïõπ ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç Í∏∞Ï¥à">Ïõπ ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç Í∏∞Ï¥à</option>
                    <option value="Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Í≥Ñ">Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Í≥Ñ</option>
                    <option value="UI/UX ÎîîÏûêÏù∏">UI/UX ÎîîÏûêÏù∏</option>
                    <option value="ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨">ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨</option>
                    <option value="ÌåÄ ÌòëÏóÖ Ïã§Ïäµ">ÌåÄ ÌòëÏóÖ Ïã§Ïäµ</option>
                </select>

                <button class="export-btn" onclick="exportToCSV()">üì• CSV Îã§Ïö¥Î°úÎìú</button>
            </div>

            <div class="attendance-table-container">
                <table class="attendance-table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th>ÎÇ†Ïßú</th>
                            <th>Í∞ïÏ¢åÎ™Ö</th>
                            <th>ÏàòÍ∞ïÏÉù</th>
                            <th>Ï∂úÏÑù ÏãúÍ∞Ñ</th>
                            <th>Ï∂úÍ≤∞ ÏÉÅÌÉú</th>
                            <th>ÏúÑÏπò ÌôïÏù∏</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- QR ÏΩîÎìú Î™®Îã¨ -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <h2 id="modalTitle">QR ÏΩîÎìú</h2>
            <p id="modalInfo"></p>
            <div id="qrcode"></div>
            <button class="close-btn" onclick="closeModal()">Îã´Í∏∞</button>
        </div>
    </div>

    <script>
        // ÍµêÏú° ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞
        const schedule = [
            {
                day: 1,
                date: '2024-11-01',
                lectures: [
                    { subject: 'Ïõπ ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç Í∏∞Ï¥à', time: '09:00-12:00', location: '101Ìò∏', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 2,
                date: '2024-11-02',
                lectures: [
                    { subject: 'Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Í≥Ñ', time: '09:00-12:00', location: '102Ìò∏', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 3,
                date: '2024-11-03',
                lectures: [
                    { subject: 'UI/UX ÎîîÏûêÏù∏', time: '09:00-12:00', location: '103Ìò∏', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 4,
                date: '2024-11-04',
                lectures: [
                    { subject: 'ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨', time: '09:00-12:00', location: '104Ìò∏', lat: 37.5665, lng: 126.9780 }
                ]
            },
            {
                day: 5,
                date: '2024-11-05',
                lectures: [
                    { subject: 'ÌåÄ ÌòëÏóÖ Ïã§Ïäµ', time: '09:00-12:00', location: '105Ìò∏', lat: 37.5665, lng: 126.9780 }
                ]
            }
        ];

        // Ï∂úÏÑù Í∏∞Î°ù Ï†ÄÏû•
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        
        // Ïû•Ïπò Í≥†Ïú† ID ÏÉùÏÑ± (Î∏åÎùºÏö∞Ï†Ä fingerprint)
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                // Í≥†Ïú† ID ÏÉùÏÑ± (ÎûúÎç§ + ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // QR Ïä§Ï∫êÎÑà Ïù∏Ïä§ÌÑ¥Ïä§
        let html5QrCode = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            renderSchedule();
            renderAttendanceTable();
            updateStats();
            initQRScanner();
        });

        // ÏùºÏ†ï Î†åÎçîÎßÅ
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';

            schedule.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                
                let lecturesHTML = '';
                day.lectures.forEach((lecture, index) => {
                    lecturesHTML += `
                        <div class="lecture-item">
                            <div class="lecture-info">
                                <div class="lecture-title">${lecture.subject}</div>
                                <div class="lecture-time">‚è∞ ${lecture.time}</div>
                                <div class="lecture-location">üìç ${lecture.location}</div>
                            </div>
                            <button class="qr-btn" onclick="generateQR(${day.day}, ${index})">
                                QR ÏÉùÏÑ±
                            </button>
                        </div>
                    `;
                });

                dayCard.innerHTML = `
                    <div class="day-header">${day.day}ÏùºÏ∞® (${day.date})</div>
                    ${lecturesHTML}
                `;

                grid.appendChild(dayCard);
            });
        }

        // QR ÏΩîÎìú ÏÉùÏÑ±
        function generateQR(day, lectureIndex) {
            const dayData = schedule[day - 1];
            const lecture = dayData.lectures[lectureIndex];
            
            const qrData = {
                day: day,
                date: dayData.date,
                subject: lecture.subject,
                time: lecture.time,
                location: lecture.location,
                lat: lecture.lat,
                lng: lecture.lng,
                timestamp: new Date().getTime()
            };

            document.getElementById('modalTitle').textContent = `${lecture.subject} QR ÏΩîÎìú`;
            document.getElementById('modalInfo').textContent = `${day}ÏùºÏ∞® | ${lecture.time} | ${lecture.location}`;
            
            document.getElementById('qrcode').innerHTML = '';
            QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(qrData), {
                width: 300,
                margin: 2
            }, function(error, canvas) {
                if (error) {
                    console.error(error);
                    return;
                }
                document.getElementById('qrcode').appendChild(canvas);
            });

            document.getElementById('qrModal').classList.add('active');
        }

        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('qrModal').classList.remove('active');
        }

        // QR Ïä§Ï∫êÎÑà Ï¥àÍ∏∞Ìôî
        function initQRScanner() {
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode = new Html5Qrcode("reader");
            
            // Ïπ¥Î©îÎùº ÏãúÏûëÏùÄ ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎê† ÎïåÎßå
            document.querySelector('[onclick*="student"]').addEventListener('click', startScanner);
        }

        function startScanner() {
            if (html5QrCode && !html5QrCode.isScanning) {
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanError
                ).catch(err => {
                    console.log("Ïπ¥Î©îÎùº ÏãúÏûë Ïã§Ìå®:", err);
                });
            }
        }

        // QR Ïä§Ï∫î ÏÑ±Í≥µ
        function onScanSuccess(decodedText, decodedResult) {
            try {
                const qrData = JSON.parse(decodedText);
                processAttendance(qrData);
            } catch (e) {
                showAlert('error', 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ QR ÏΩîÎìúÏûÖÎãàÎã§.');
            }
        }

        function onScanError(errorMessage) {
            // Ïä§Ï∫î ÏóêÎü¨Îäî Î¨¥Ïãú (Í≥ÑÏÜç Ïä§Ï∫î)
        }

        // Ï∂úÏÑù Ï≤òÎ¶¨
        function processAttendance(qrData) {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showAlert('error', 'Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÏúÑÏπò ÌôïÏù∏
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const distance = calculateDistance(
                            position.coords.latitude,
                            position.coords.longitude,
                            qrData.lat,
                            qrData.lng
                        );

                        // 500m Ïù¥ÎÇ¥Îßå Ï∂úÏÑù Ïù∏Ï†ï
                        if (distance > 0.5) {
                            showAlert('error', 'Ï∂úÏÑù Í∞ÄÎä•Ìïú ÏúÑÏπòÍ∞Ä ÏïÑÎãôÎãàÎã§. (Í±∞Î¶¨: ' + distance.toFixed(2) + 'km)');
                            return;
                        }

                        // ÏãúÍ∞Ñ ÌôïÏù∏
                        const [startTime, endTime] = qrData.time.split('-');
                        const now = new Date();
                        const currentTime = now.getHours() * 60 + now.getMinutes();
                        const [startHour, startMin] = startTime.split(':').map(Number);
                        const [endHour, endMin] = endTime.split(':').map(Number);
                        const classStart = startHour * 60 + startMin;
                        const classEnd = endHour * 60 + endMin;

                        let status = 'Ï∂úÏÑù';
                        if (currentTime < classStart) {
                            showAlert('error', 'ÏïÑÏßÅ Ï∂úÏÑù ÏãúÍ∞ÑÏù¥ ÏïÑÎãôÎãàÎã§.');
                            return;
                        } else if (currentTime > classEnd) {
                            showAlert('error', 'Ï∂úÏÑù ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
                            return;
                        } else if (currentTime > classStart + 10) {
                            status = 'ÏßÄÍ∞Å';
                        }

                        // Ïû•Ïπò ID Í∞ÄÏ†∏Ïò§Í∏∞
                        const deviceId = getDeviceId();
                        
                        // Ï§ëÎ≥µ Ï∂úÏÑù ÌôïÏù∏ 1: Í∞ôÏùÄ Ïù¥Î¶ÑÏúºÎ°ú Ïù¥ÎØ∏ Ï∂úÏÑùÌñàÎäîÏßÄ
                        const duplicateName = attendanceRecords.find(r => 
                            r.name === studentName && 
                            r.day === qrData.day && 
                            r.subject === qrData.subject
                        );

                        if (duplicateName) {
                            showAlert('warning', 'Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.');
                            return;
                        }
                        
                        // Ï§ëÎ≥µ Ï∂úÏÑù ÌôïÏù∏ 2: Í∞ôÏùÄ Ïû•ÏπòÏóêÏÑú Ïù¥ÎØ∏ Ï∂úÏÑùÌñàÎäîÏßÄ (ÎåÄÎ¶¨Ï∂úÏÑù Î∞©ÏßÄ)
                        const duplicateDevice = attendanceRecords.find(r => 
                            r.deviceId === deviceId && 
                            r.day === qrData.day && 
                            r.subject === qrData.subject
                        );

                        if (duplicateDevice) {
                            showAlert('error', `Ïù¥ Í∏∞Í∏∞Îäî Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.\nÏ∂úÏÑùÏûê: ${duplicateDevice.name}\n\nÎåÄÎ¶¨ Ï∂úÏÑùÏùÄ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.`);
                            return;
                        }

                        // Ï∂úÏÑù Í∏∞Î°ù Ï†ÄÏû•
                        const record = {
                            day: qrData.day,
                            date: qrData.date,
                            subject: qrData.subject,
                            name: studentName,
                            time: now.toLocaleTimeString('ko-KR'),
                            status: status,
                            location: qrData.location,
                            distance: distance.toFixed(3) + 'km',
                            timestamp: now.getTime(),
                            deviceId: deviceId  // Ïû•Ïπò ID Ï∂îÍ∞Ä
                        };

                        attendanceRecords.push(record);
                        localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));

                        showAlert('success', `Ï∂úÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! (${status})`);
                        renderAttendanceTable();
                        updateStats();

                        // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                        document.getElementById('studentName').value = '';
                    },
                    (error) => {
                        showAlert('error', 'ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÏúÑÏπò Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showAlert('error', 'Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            }
        }

        // ÏàòÎèô Ï∂úÏÑù (ÌÖåÏä§Ìä∏Ïö©)
        function manualAttendance() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showAlert('error', 'Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÌòÑÏû¨ ÎÇ†Ïßú Í∏∞Ï§ÄÏúºÎ°ú Í∞ÄÏû• Í∞ÄÍπåÏö¥ Í∞ïÏùò Ï∞æÍ∏∞
            const now = new Date();
            const currentHour = now.getHours();
            
            // Ïò§Ï†Ñ 9Ïãú~12Ïãú ÏÇ¨Ïù¥Îßå Ï∂úÏÑù Í∞ÄÎä•
            if (currentHour < 9 || currentHour >= 12) {
                showAlert('error', 'Ï∂úÏÑù Í∞ÄÎä• ÏãúÍ∞ÑÏù¥ ÏïÑÎãôÎãàÎã§. (09:00-12:00)');
                return;
            }

            // ÏûÑÏãúÎ°ú 1ÏùºÏ∞® Í∞ïÏùòÎ°ú Ï∂úÏÑù Ï≤òÎ¶¨ (Ïã§Ï†úÎ°úÎäî ÎÇ†Ïßú ÎπÑÍµê ÌïÑÏöî)
            const dayData = schedule[0];
            const lecture = dayData.lectures[0];

            // Ïû•Ïπò ID Í∞ÄÏ†∏Ïò§Í∏∞
            const deviceId = getDeviceId();
            
            // Ï§ëÎ≥µ ÌôïÏù∏
            const duplicateDevice = attendanceRecords.find(r => 
                r.deviceId === deviceId && 
                r.day === dayData.day && 
                r.subject === lecture.subject
            );

            if (duplicateDevice) {
                showAlert('error', `Ïù¥ Í∏∞Í∏∞Îäî Ïù¥ÎØ∏ Ï∂úÏÑù Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.\nÏ∂úÏÑùÏûê: ${duplicateDevice.name}\n\nÎåÄÎ¶¨ Ï∂úÏÑùÏùÄ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.`);
                return;
            }
            
            const record = {
                day: dayData.day,
                date: dayData.date,
                subject: lecture.subject,
                name: studentName,
                time: now.toLocaleTimeString('ko-KR'),
                status: 'Ï∂úÏÑù',
                location: lecture.location,
                distance: 'ÏàòÎèôÏ≤¥ÌÅ¨',
                timestamp: now.getTime(),
                deviceId: deviceId  // Ïû•Ïπò ID Ï∂îÍ∞Ä
            };

            attendanceRecords.push(record);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));

            showAlert('success', 'Ï∂úÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
            renderAttendanceTable();
            updateStats();

            document.getElementById('studentName').value = '';
        }

        // Í±∞Î¶¨ Í≥ÑÏÇ∞ (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Ï∂úÏÑùÎ∂Ä Î†åÎçîÎßÅ
        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceBody');
            tbody.innerHTML = '';

            const filterDay = document.getElementById('filterDay')?.value;
            const filterSubject = document.getElementById('filterSubject')?.value;

            let filteredRecords = attendanceRecords;

            if (filterDay) {
                filteredRecords = filteredRecords.filter(r => r.day == filterDay);
            }

            if (filterSubject) {
                filteredRecords = filteredRecords.filter(r => r.subject === filterSubject);
            }

            // ÏµúÏã†Ïàú Ï†ïÎ†¨
            filteredRecords.sort((a, b) => b.timestamp - a.timestamp);

            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                const statusClass = record.status === 'Ï∂úÏÑù' ? 'status-present' : 
                                  record.status === 'ÏßÄÍ∞Å' ? 'status-late' : 'status-absent';
                
                row.innerHTML = `
                    <td>${record.day}ÏùºÏ∞® (${record.date})</td>
                    <td>${record.subject}</td>
                    <td>${record.name}</td>
                    <td>${record.time}</td>
                    <td class="${statusClass}">${record.status}</td>
                    <td>${record.distance}</td>
                `;
                tbody.appendChild(row);
            });

            if (filteredRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999;">Ï∂úÏÑù Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
            }
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const totalRecords = attendanceRecords.length;
            const presentCount = attendanceRecords.filter(r => r.status === 'Ï∂úÏÑù').length;
            const lateCount = attendanceRecords.filter(r => r.status === 'ÏßÄÍ∞Å').length;
            const uniqueStudents = new Set(attendanceRecords.map(r => r.name)).size;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalRecords}</div>
                    <div class="stat-label">Ï¥ù Ï∂úÏÑù Í∏∞Î°ù</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${presentCount}</div>
                    <div class="stat-label">Ï†ïÏÉÅ Ï∂úÏÑù</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${lateCount}</div>
                    <div class="stat-label">ÏßÄÍ∞Å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${uniqueStudents}</div>
                    <div class="stat-label">ÏàòÍ∞ïÏÉù Ïàò</div>
                </div>
            `;
        }

        // ÌïÑÌÑ∞ÎßÅ
        function filterAttendance() {
            renderAttendanceTable();
        }

        // CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportToCSV() {
            if (attendanceRecords.length === 0) {
                alert('Ï∂úÏÑù Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            let csv = 'ÎÇ†Ïßú,Í∞ïÏ¢åÎ™Ö,ÏàòÍ∞ïÏÉù,Ï∂úÏÑùÏãúÍ∞Ñ,Ï∂úÍ≤∞ÏÉÅÌÉú,ÏúÑÏπòÌôïÏù∏\n';
            
            attendanceRecords.forEach(record => {
                csv += `${record.day}ÏùºÏ∞® (${record.date}),${record.subject},${record.name},${record.time},${record.status},${record.distance}\n`;
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Ï∂úÏÑùÎ∂Ä_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ÏïåÎ¶º ÌëúÏãú
        function showAlert(type, message) {
            const alertDiv = document.getElementById('studentAlert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';

            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // ÌÉ≠ Ï†ÑÌôò
        function switchTab(tabName) {
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // QR Ïä§Ï∫êÎÑà ÏãúÏûë/Ï†ïÏßÄ
            if (tabName === 'student') {
                setTimeout(startScanner, 100);
            } else if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }

            // Ï∂úÏÑùÎ∂Ä ÌÉ≠Ïùº Í≤ΩÏö∞ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
            if (tabName === 'records') {
                renderAttendanceTable();
                updateStats();
            }
        }

        // ÌéòÏù¥ÏßÄ ÎÇòÍ∞à Îïå Ïπ¥Î©îÎùº Ï†ïÏßÄ
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>